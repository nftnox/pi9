<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil korisnika</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>

    <header class="header-container">
        <div id="greeting">Pozdrav, <span id="logged-in-user"></span></div>
        <div id="current-price-display">Your wallet: <span id="current-price">0.00</span> <span class="delta">&#948;</span></div>
        
        <!-- Toggle button for mobile devices -->
        <button id="toggle-menu-button" class="toggle-button">☰</button>
        
        <!-- Desktop menu -->
        <nav id="desktop-menu">
            <a href="#"><span class="material-icons">home</span> Home</a>
            <a href="#"><span class="material-icons">group</span> Team</a>
            <a href="#" id="chat-link"><span class="material-icons">chat</span> Chat</a>
            <a href="#"><span class="material-icons">person</span> Profile</a>
        </nav>

        <nav id="toggle-menu">
            <a href="#"><span class="material-icons">home</span> Home</a>
            <a href="#"><span class="material-icons">group</span> Team</a>
            <a href="#" id="chat-link"><span class="material-icons">chat</span> Chat</a>
            <a href="#"><span class="material-icons">person</span> Profile</a>
        </nav>
    </header>

    <script>
        const toggleMenuButton = document.getElementById('toggle-menu-button');
        const toggleMenu = document.getElementById('toggle-menu');

        toggleMenuButton.addEventListener('click', () => {
            if (toggleMenu.style.display === 'flex') {
                toggleMenu.style.display = 'none';
            } else {
                toggleMenu.style.display = 'flex';
            }
        });
    </script>

    <div class="image-container">
        <img src="images/delta.png" alt="Delta Image" style="max-width: 100%; height: auto;">
    </div>

    <div class="partnership-box">
        <p>
            Delta coin is selecting partnerships with crypto-services and general businesses ahead of our Open Network launch. 
            This is a unique, early opportunity for businesses to connect with over 10 million engaged Delta coin fans and become part of Delta’s rapidly expanding Web3 ecosystem. 
            If your company is interested in partnering with Delta or you’d like to introduce a business to partner with Delta, tap “Partnerships” to explore how and why.
        </p>
    </div>

    <div class="background blue"></div>
    <div class="background purple"></div>

    <div class="profile-outline">
        <div class="profile-header">
            <div id="profile-title" class="profile-title"></div>
            <div class="profile-picture" id="profile-picture"></div>
        </div>
    
        <div id="eth-account-section" style="display: none; margin-top: 20px; text-align: center; background-color: #ffcccc; padding: 10px; border-radius: 8px;">
            <label for="eth-address-input" style="color: #800000; font-weight: bold;">Vaš MetaMask račun:</label>
            <input type="text" id="eth-address-input" placeholder="Unesite vašu Ethereum adresu" style="margin-top: 10px; padding: 5px; width: 60%; border: 1px solid #800000;" disabled>
            <button id="save-eth-address" style="margin-top: 10px; padding: 5px; background-color: #800000; color: white; border: none; border-radius: 5px; cursor: pointer;">Spremi adresu</button>
            <button id="edit-eth-address" style="margin-top: 10px; padding: 5px; background-color: #800000; color: white; border: none; border-radius: 5px; cursor: pointer; display: none;">Promeni adresu</button>
        </div>
        
        <div id="profile-products" class="product-list-container"></div>
    </div>
    
    <div id="transaction-history" class="product-list-container">
        <div id="transaction-title" class="profile-title">Historija transakcija</div>
    </div>


    <!-- DODANO: Marketplace adresa i ABI -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, query, where, doc, getDoc, updateDoc, addDoc
        } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBKfTE0qZdxVLq0lvmli367_yyqpGK-fPA",
            authDomain: "piii-7844e.firebaseapp.com",
            projectId: "piii-7844e",
            storageBucket: "piii-7844e.appspot.com",
            messagingSenderId: "315770496799",
            appId: "1:315770496799:web:0197d4baf2c8731d88722a",
            measurementId: "G-JH9SDWTS9V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // PARAMETRI IZ URL-A
        const params = new URLSearchParams(window.location.search);
        const profileName = params.get('ime');
        const loggedInUser = params.get('loggedInUser');
        let currentPrice = parseFloat(params.get('trenutnaCijena'));

        let loggedInUserIme = ''; 
        let loggedInUserId = ''; 

        async function getLoggedInUserIme() {
            const userCollection = collection(db, 'network');
            const q = query(userCollection, where('username', '==', loggedInUser));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                querySnapshot.forEach(docSnap => {
                    const userData = docSnap.data();
                    loggedInUserIme = `${userData.ime} ${userData.prezime}`;
                    loggedInUserId = docSnap.id;
                });
            } else {
                console.error("Prijavljeni korisnik nije pronađen u Firestore-u.");
            }
        }

        // DODANO: Marketplace adresa i ABI (isto kao na index.html, prilagođeno)
        const marketplaceAddress = "0xe25922FB4CC65433826D9b46339c6e780cdC775E";
        const marketplaceABI = [
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "buyNFT",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "cancelListing",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "price",
                        "type": "uint256"
                    }
                ],
                "name": "listNFT",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_nftAddress",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "_lunaTokenAddress",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "price",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "seller",
                        "type": "address"
                    }
                ],
                "name": "NFTListed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "price",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "seller",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "buyer",
                        "type": "address"
                    }
                ],
                "name": "NFTSold",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "listings",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "price",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "seller",
                        "type": "address"
                    },
                    {
                        "internalType": "bool",
                        "name": "active",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "lunaToken",
                "outputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "nftContract",
                "outputs": [
                    {
                        "internalType": "contract IERC721",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // NFT KONTRAKT
        const nftContractAddress = "0x96c475e10479018cc028D39c71973470fD19f063"; 
        const nftContractABI = [
            // ... (isti ABI koji si već imao za NFT - NE mijenjaj)
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "tokenURI",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // LUNA KONTRAKT
        const contractAddress = "0x19C16A8eb27Bfd879e3BEB044A2f094568F9F672"; 
        const contractABI = [
            // ... (tvoj ERC20 Luna token ABI - NE mijenjaj)
        ];

        // Pokreni sve
        await getLoggedInUserIme(); 
        await loadProfileOwnerData(); 
        await loadProfileProducts(); 
        await loadTransactionHistory(); 

        // Prikaži ime prijavljenog korisnika i trenutnu cijenu
        document.getElementById('logged-in-user').innerText = loggedInUserIme;
        document.getElementById('current-price').innerText = currentPrice.toFixed(2);

        const profileTitle = document.getElementById('profile-title');
        profileTitle.innerText = (loggedInUserIme === profileName)
            ? 'Vaš profil'
            : `Profil korisnika: ${profileName}`;

        // Ako je korisnik na svom profilu, prikažemo polje za unos Ethereum adrese
        if (loggedInUserIme === profileName) {
            document.getElementById('eth-account-section').style.display = 'block';
            await setupEthAddressSection();
        }

        // FUNKCIJA: Setup ETH adrese (spremanje, izmjena)
        async function setupEthAddressSection() {
            const userDocRef = doc(db, 'network', loggedInUserId);
            const userDocSnap = await getDoc(userDocRef);

            const ethAddressInput = document.getElementById('eth-address-input');
            const saveEthAddressButton = document.getElementById('save-eth-address');
            const editEthAddressButton = document.getElementById('edit-eth-address');

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                if (userData.ethAddress) {
                    ethAddressInput.value = userData.ethAddress;
                    ethAddressInput.disabled = true;
                    saveEthAddressButton.style.display = 'none';
                    editEthAddressButton.style.display = 'inline-block';
                } else {
                    ethAddressInput.disabled = false;
                    saveEthAddressButton.style.display = 'inline-block';
                    editEthAddressButton.style.display = 'none';
                }
            }

            editEthAddressButton.addEventListener('click', () => {
                ethAddressInput.disabled = false;
                ethAddressInput.value = ''; 
                saveEthAddressButton.style.display = 'inline-block';
                editEthAddressButton.style.display = 'none';
            });

            saveEthAddressButton.addEventListener('click', async () => {
                const newEthAddress = ethAddressInput.value.trim();
                if (typeof window.Web3 !== 'undefined') {
                    const web3 = new Web3(window.ethereum);
                    if (web3.utils.isAddress(newEthAddress)) {
                        try {
                            await updateDoc(userDocRef, { ethAddress: newEthAddress });
                            alert('Ethereum adresa uspješno spremljena!');
                            ethAddressInput.value = newEthAddress;
                            ethAddressInput.disabled = true;
                            saveEthAddressButton.style.display = 'none';
                            editEthAddressButton.style.display = 'inline-block';
                        } catch (error) {
                            console.error('Greška prilikom spremanja Ethereum adrese:', error);
                            alert('Došlo je do greške. Pokušajte ponovo.');
                        }
                    } else {
                        alert('Unesite ispravnu Ethereum adresu.');
                    }
                } else {
                    alert('Web3 nije dostupan. Provjerite da li je MetaMask instaliran.');
                }
            });
        }

        // FUNKCIJA: Učitavanje proizvoda na profilu
        async function loadProfileProducts() {
            const productCollection = collection(db, 'products');
            const querySnapshot = await getDocs(productCollection);
            const profileProducts = document.getElementById('profile-products');
            profileProducts.innerHTML = '';

            querySnapshot.forEach(docSnap => {
                const productData = docSnap.data();

                if (productData.ownerName === profileName) {
                    const productDiv = document.createElement('div');
                    productDiv.classList.add('product');

                    const productImg = document.createElement('img');
                    productImg.src = productData.imageUrl;
                    productDiv.appendChild(productImg);

                    const productName = document.createElement('div');
                    productName.classList.add('product-name');
                    productName.innerText = productData.name;
                    productDiv.appendChild(productName);

                    const productPrice = document.createElement('div');
                    productPrice.classList.add('product-price');
                    productPrice.innerText = `Cijena: ${productData.price} Luna Coin`;
                    productDiv.appendChild(productPrice);

                    // Ako postoji cijena u ETH
                    if (productData.cryptoPrice) {
                        const productCryptoPrice = document.createElement('div');
                        productCryptoPrice.classList.add('product-price');
                        productCryptoPrice.innerText = `Cijena u ETH: ${productData.cryptoPrice} ETH`;
                        productDiv.appendChild(productCryptoPrice);
                    }

                    // Ako je to vlasnik profila:
                    if (profileName === loggedInUserIme) {
                        const priceInput = document.createElement('input');
                        priceInput.type = 'number';
                        priceInput.placeholder = 'Nova cijena (Delta coin)';
                        priceInput.classList.add('input-price');

                        const cryptoPriceInput = document.createElement('input');
                        cryptoPriceInput.type = 'number';
                        cryptoPriceInput.placeholder = 'Nova cijena (ETH)';
                        cryptoPriceInput.classList.add('input-price');

                        const setPriceButton = document.createElement('button');
                        setPriceButton.innerText = 'Postavi cijene';
                        setPriceButton.classList.add('set-price-button');

                        // DODANO: Ovdje radimo setApprovalForAll + listNFT
                        setPriceButton.addEventListener('click', async () => {
                            if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                                try {
                                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                                    const web3 = new Web3(window.ethereum);
                                    const nftContract = new web3.eth.Contract(nftContractABI, nftContractAddress);
                                    const accounts = await web3.eth.getAccounts();
                                    const currentAccount = accounts[0]; 

                                    // Omogući marketplaceu transfere
                                    await nftContract.methods
                                        .setApprovalForAll(marketplaceAddress, true)
                                        .send({ from: currentAccount });

                                    const novaCijena = parseFloat(priceInput.value);
                                    const novaCryptoCijena = parseFloat(cryptoPriceInput.value);

                                    // Ažuriraj Firestore (lokalno)
                                    const updateData = {};
                                    if (!isNaN(novaCijena) && novaCijena > 0) {
                                        updateData.price = novaCijena;
                                    }
                                    if (!isNaN(novaCryptoCijena) && novaCryptoCijena > 0) {
                                        updateData.cryptoPrice = novaCryptoCijena;
                                    }
                                    // updateDoc => Spremi nove cijene
                                    await updateDoc(doc(db, 'products', docSnap.id), updateData);

                                    // DODANO: Listaj NFT na Marketplace
                                    const marketplaceContract = new web3.eth.Contract(marketplaceABI, marketplaceAddress);
                                    const tokenId = productData.tokenId; // iz Firestore
                                    
                                    // Ako želimo listati za Luna Coin -> marketplace čeka "priceInWei" (npr. pretpostavimo da je to ETH listing)
                                    // Ovdje za demo stavljamo ETH listu:
                                    const priceString = (!isNaN(novaCijena) && novaCijena > 0) 
                                        ? novaCijena.toString() 
                                        : "1"; // ako nije unio, stavi default
                                    const priceInWei = web3.utils.toWei(priceString, 'ether');

                                    await marketplaceContract.methods
                                        .listNFT(tokenId, priceInWei)
                                        .send({ from: currentAccount });

                                    alert('✅ Nove cijene postavljene i NFT listan na Marketplace!');
                                    loadProfileProducts(); 
                                } catch (error) {
                                    console.error('❌ Greška prilikom postavljanja cijene:', error);
                                    alert('Došlo je do greške. Pokušajte ponovo.');
                                }
                            } else {
                                alert('❌ Molimo instalirajte MetaMask ili omogućite ga.');
                            }
                        });

                        productDiv.appendChild(priceInput);
                        productDiv.appendChild(cryptoPriceInput);
                        productDiv.appendChild(setPriceButton);
                    } else {
                        // Inače je netko drugi, prikaži gumb Kupi
                        // Kupi Luna Coin
                        const buyButton = document.createElement('button');
                        buyButton.innerText = 'Kupi (Luna Coin)';
                        buyButton.classList.add('buy-button');
                        buyButton.addEventListener('click', async () => {
                            await handleLunaPurchase(docSnap.id, productData);
                        });
                        productDiv.appendChild(buyButton);

                        // Kupi ETH
                        const buyWithCryptoButton = document.createElement('button');
                        buyWithCryptoButton.innerText = 'Kupi (ETH)';
                        buyWithCryptoButton.classList.add('buy-button');
                        buyWithCryptoButton.style.backgroundColor = 'purple';
                        buyWithCryptoButton.addEventListener('click', async () => {
                            await handleCryptoPurchase(docSnap.id, productData);
                        });
                        productDiv.appendChild(buyWithCryptoButton);
                    }

                    profileProducts.appendChild(productDiv);
                }
            });
        }

        // FUNKCIJA: Kad kupac klikne "Kupi (ETH)"
        async function handleCryptoPurchase(productId, productData) {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const web3 = new Web3(window.ethereum);
                    const accounts = await web3.eth.getAccounts();
                    const buyerAccount = accounts[0];

                    // DODANO: Umjesto ručnog safeTransferFrom, sada pozivamo marketplace "buyNFT"
                    const marketplaceContract = new web3.eth.Contract(marketplaceABI, marketplaceAddress);

                    // Ako unutar marketplacea traži "value" (ETH) za NFT
                    // => parse float i pretvori u wei
                    let weiValue = '0';
                    if (productData.cryptoPrice) {
                        const ethPrice = productData.cryptoPrice; // npr. 0.05
                        weiValue = web3.utils.toWei(ethPrice.toString(), 'ether');
                    }
                    
                    // Kupac kupuje NFT
                    await marketplaceContract.methods
                        .buyNFT(productData.tokenId)
                        .send({
                            from: buyerAccount,
                            value: weiValue // ako je marketplace definiran da primi ETH
                        });

                    alert('Uspješna kupnja i NFT prijenos preko Marketplace-a!');

                    // Ovdje radimo "ručno" ažuriranje Firestore balansa 
                    // - ODUZIMANJE novca iz buyer walleta, DODAVANJE prodavcu, 
                    //   ali samo ako to i dalje želiš raditi off-chain.
                    //   (Ovo je dio tvoje postojeće logike s "currentPrice".)
                    
                    // 1) Oduzmi iz kupčevog Firestore walleta
                    const buyerDocRef = doc(db, 'network', loggedInUserId);
                    const buyerDocSnap = await getDoc(buyerDocRef);
                    if (buyerDocSnap.exists()) {
                        let buyerCurPrice = buyerDocSnap.data().currentPrice || 0;
                        // Oduzmemo "productData.price" => to je Luna Coin, 
                        //   ali ovdje nije nužno isto što i ETH. Tvoja odluka.
                        buyerCurPrice -= productData.price; 
                        await updateDoc(buyerDocRef, { currentPrice: buyerCurPrice });
                        document.getElementById('current-price').innerText = buyerCurPrice.toFixed(2);
                    }

                    // 2) Dodaj prodavcu
                    //    Moramo dohvatiti ID prodavca iz Firestorea -> productData.owner
                    //    (pod pretpostavkom da si "owner" spremao kao Firestore ID)
                    const sellerDocRef = doc(db, 'network', productData.owner);
                    const sellerDocSnap = await getDoc(sellerDocRef);
                    if (sellerDocSnap.exists()) {
                        let sellerPrice = sellerDocSnap.data().currentPrice || 0;
                        sellerPrice += productData.price;
                        await updateDoc(sellerDocRef, { currentPrice: sellerPrice });
                    }

                    // 3) Ažuriraj "products" dokument: novi vlasnik
                    await updateDoc(doc(db, 'products', productId), {
                        owner: loggedInUserId,
                        ownerName: loggedInUserIme,
                        sold: true
                    });

                    // 4) Upis u "purchases"
                    const userPurchasesRef = collection(db, `network/${loggedInUserId}/purchases`);
                    await addDoc(userPurchasesRef, {
                        name: productData.name,
                        imageUrl: productData.imageUrl,
                        price: productData.price,
                        purchaseTime: new Date()
                    });

                    loadProfileProducts(); 
                } catch (error) {
                    console.error('Greška prilikom kupnje (ETH):', error);
                    alert('Došlo je do greške. Pokušajte ponovo.');
                }
            } else {
                alert('Molimo instalirajte MetaMask ekstenziju ili je omogućite.');
            }
        }

        // FUNKCIJA: Kad kupac klikne "Kupi (Luna Coin)"
        async function handleLunaPurchase(productId, productData) {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const web3 = new Web3(window.ethereum);
                    const accounts = await web3.eth.getAccounts();
                    const buyerAccount = accounts[0];

                    // Provjera balansa LUNA tokena
                    const lunaTokenContract = new web3.eth.Contract(contractABI, contractAddress);
                    const userBalance = await lunaTokenContract.methods.balanceOf(buyerAccount).call();
                    const requiredAmount = web3.utils.toWei(productData.price.toString(), 'ether');

                    if (parseFloat(userBalance) < parseFloat(requiredAmount)) {
                        alert('Nemate dovoljno Luna tokena za ovu transakciju.');
                        return;
                    }

                    // Prodavač
                    const sellerDocRef = doc(db, 'network', productData.owner);
                    const sellerDocSnap = await getDoc(sellerDocRef);
                    const sellerEthAddress = sellerDocSnap.data().ethAddress;
                    if (!sellerEthAddress) {
                        alert('Prodavac nema postavljenu Ethereum adresu.');
                        return;
                    }

                    // 1) Transfer LUNA tokena od kupca -> prodavac
                    await lunaTokenContract.methods
                        .transfer(sellerEthAddress, requiredAmount)
                        .send({ from: buyerAccount });

                    alert(`Kupili ste ${productData.name} za ${productData.price} Luna Coin!`);

                    // 2) Sada i ovdje prelazimo na prenošenje NFT-a 
                    //    preko Marketplace-a (buyNFT) ili direct safeTransferFrom (ali treba approval).
                    //    Bolje je i ovdje ponoviti "buyNFT", ali tvoj marketplace trenutno 
                    //    možda to ne podržava za LUNA. 
                    //    Ako hoćeš direct safeTransferFrom, treba potpisati "sellerEthAddress".
                    //    No, to nije izvedivo dok "seller" ne pokrene transakciju. 
                    //
                    //    Najjednostavnije: 
                    //    - Kao i gore, "listNFT" pa "buyNFT" => ali to je za ETH. 
                    //    - Za LUNA je custom. 
                    // 
                    //    Za sada ćemo TVOJ off-chain Firestore approach:
                    //    Dakle, RUČNO samo promijenimo "owner" u Firestore-u (nema pravog NFT transfera).
                    //    => Ili dodaš logiku "seller" potpiše transakciju.
                    // 
                    //    Za DEMO, radimo isto "owner" = buyer. 
                    //    (NFT NIKAD nije prenesen on-chain, no to je tvoja aplikacija.)
                    // 
                    //    Upozorenje: Ovdje NFT ne prelazi on-chain. 
                    //    Ako ga doista želiš on-chain prebaciti, mora "seller" ili marketplace to učiniti.
                    
                    await updateDoc(doc(db, 'products', productId), {
                        owner: loggedInUserId,
                        ownerName: loggedInUserIme,
                        sold: true
                    });

                    // Upis u purchases
                    const userPurchasesRef = collection(db, `network/${loggedInUserId}/purchases`);
                    await addDoc(userPurchasesRef, {
                        name: productData.name,
                        imageUrl: productData.imageUrl,
                        price: productData.price,
                        purchaseTime: new Date()
                    });

                    loadProfileProducts();
                } catch (error) {
                    console.error('Greška prilikom obrade transakcije (Luna Coin):', error);
                    alert('Došlo je do greške. Pokušajte ponovo.');
                }
            } else {
                alert('Molimo instalirajte MetaMask ili ga omogućite.');
            }
        }

        // FUNKCIJA: Učitavanje historije transakcija
        async function loadTransactionHistory() {
            const userCollection = collection(db, 'network');
            const [ime, prezime] = profileName.split(' ');
            const q = query(userCollection, where('ime', '==', ime), where('prezime', '==', prezime));
            const userSnapshot = await getDocs(q);

            if (!userSnapshot.empty) {
                let profileUserId = '';
                userSnapshot.forEach(docSnap => {
                    profileUserId = docSnap.id;
                });

                const purchasesRef = collection(db, `network/${profileUserId}/purchases`);
                const purchasesSnapshot = await getDocs(purchasesRef);
                const transactionHistoryDiv = document.getElementById('transaction-history');
                transactionHistoryDiv.innerHTML = '';

                if (!purchasesSnapshot.empty) {
                    purchasesSnapshot.forEach(docSnap => {
                        const purchaseData = docSnap.data();

                        const transactionDiv = document.createElement('div');
                        transactionDiv.classList.add('transaction-item');

                        const productImg = document.createElement('img');
                        productImg.src = purchaseData.imageUrl;
                        transactionDiv.appendChild(productImg);

                        const transactionDetails = document.createElement('div');
                        transactionDetails.classList.add('transaction-details');

                        const productName = document.createElement('span');
                        productName.classList.add('transaction-name');
                        productName.innerText = purchaseData.name;

                        const purchasePrice = document.createElement('span');
                        purchasePrice.classList.add('transaction-price');
                        purchasePrice.innerText = `Cijena: ${purchaseData.price} Delta coin`;

                        const purchaseTime = document.createElement('span');
                        purchaseTime.classList.add('transaction-time');
                        purchaseTime.innerText = `Vrijeme kupovine: ${purchaseData.purchaseTime.toDate().toLocaleString()}`;

                        transactionDetails.appendChild(productName);
                        transactionDetails.appendChild(purchasePrice);
                        transactionDetails.appendChild(purchaseTime);
                        transactionDiv.appendChild(transactionDetails);

                        transactionHistoryDiv.appendChild(transactionDiv);
                    });
                } else {
                    const noTransactionsMessage = document.createElement('div');
                    noTransactionsMessage.innerText = 'Nema transakcija.';
                    noTransactionsMessage.style.textAlign = 'center';
                    transactionHistoryDiv.appendChild(noTransactionsMessage);
                }
            } else {
                console.error("Korisnik nije pronađen u Firestore-u za transakcije:", ime, prezime);
            }
        }

        // FUNKCIJA: Učitavanje podataka vlasnika profila
        async function loadProfileOwnerData() {
            const userCollection = collection(db, 'network');
            const [ime, prezime] = profileName.split(' '); 

            const q = query(userCollection, where('ime', '==', ime), where('prezime', '==', prezime));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                querySnapshot.forEach(docSnap => {
                    const userData = docSnap.data();
                    if (loggedInUserIme === profileName) {
                        document.getElementById('profile-title').innerText = 'Vaš profil';
                    } else {
                        document.getElementById('profile-title').innerText = `Profil korisnika: ${profileName}`;
                    }
                });
            } else {
                console.error("Korisnik nije pronađen u Firestore-u:", ime, prezime);
            }
        }

        // FUNKCIJA: Ako je ovo naš profil, učitaj više detalja
        async function loadUserProfile() {
            if (loggedInUserIme === profileName) {
                const userDocRef = doc(db, 'network', loggedInUserId);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();

                    const profileTitle = document.getElementById('profile-title');
                    const userInfoDiv = document.createElement('div');
                    userInfoDiv.classList.add('user-info');

                    userInfoDiv.innerHTML = `
                        <p><strong>Username:</strong> ${userData.username}</p>
                        <p><strong>Total Price:</strong> ${userData.totalPrice.toFixed(2)}</p>
                        <p><strong>Email:</strong> ${userData.email}</p>
                        <p><strong>Used By:</strong></p>
                        <ul id="used-by-list"></ul>
                    `;

                    profileTitle.appendChild(userInfoDiv);

                    if (userData.usedBy && userData.usedBy.length > 0) {
                        const usedByList = document.getElementById('used-by-list');
                        for (const refUserId of userData.usedBy) {
                            const userRef = doc(db, 'network', refUserId);
                            const userSnap = await getDoc(userRef);
                            if (userSnap.exists()) {
                                const uInfo = userSnap.data();
                                const listItem = document.createElement('li');
                                listItem.textContent = `${uInfo.ime} ${uInfo.prezime}`;
                                usedByList.appendChild(listItem);
                            }
                        }
                    } else {
                        document.getElementById('used-by-list').innerHTML = '<li>Nema referisanih korisnika.</li>';
                    }
                }
            }
        }

        // Ako želiš i to prikazivati
        await loadUserProfile();
    </script>
</body>
</html>










<style>
    input,
    textarea {
        touch-action: manipulation; /* Omogućava manipulaciju bez zumiranja */
        
    }
    
    
          
    
    
    /* User info styling */
    
    
    
    
    
    
    
    
    
    
    
    
    /* Main container for all products */
    .marketplace-outline {
        padding: 20px;
        border: 2px solid #ccc; /* Outer border for the entire marketplace */
        background-color: #fff; /* White background */
        border-radius: 10px;
        max-width: 1200px;
        margin: 0 auto; /* Center the container */
    }
    
    /* Container for individual products */
    .product {
            border: 5px solid; /* Postavite debljinu obruba */
            border-image: linear-gradient(to right, #5a99cd, #4b0078) 1; /* Gradijentni obrub s lijeva na desno */
            border-radius: 8px; /* Zaobljeni uglovi */
            padding: 10px; /* Unutarnji razmak */
            margin: 10px; /* Vanjski razmak između proizvoda */
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); /* Blaga sjena za bolji izgled */
        }
    
        .product img {
            width: 200px;
            height: 200px;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 8px;
        }
    
        .product-list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Razmak između proizvoda */
            justify-content: center; /* Centriranje proizvoda */
        }
    
    /* Individual product box */
    .product-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 200px; /* Set fixed width */
        height: 300px; /* Set fixed height */
        padding: 10px;
        background-color: #f9f9f9; /* Light background for products */
        border: 1px solid #ccc; /* Border for each product */
        border-radius: 8px;
        box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    /* Image styling for each product */
    .product-box img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    
    /* Product name styling */
    .product-name {
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 5px;
    }
    
    /* Product price styling */
    .product-price {
        font-size: 14px;
        color: #333;
        margin-bottom: 10px;
    }
    
    /* 'Kupi' button styling */
    .buy-button {
        width: 100%;
        padding: 8px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .buy-button:hover {
        background-color: #45a049;
    }
    
    .marketplace-outline h2 {
            text-align: center; /* Centrira tekst naslova */
            margin-bottom: 20px; /* Dodaje razmak ispod naslova */
            font-weight: bold; /* Podebljava naslov */
        }
    
            /* Stilovi za profilnu stranicu */
            .profile-container {
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }
    
            .header-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
    
    
    
    
    
    
           .profile-outline {
                padding: 20px;
                border: 2px solid #ccc; /* Outer border for the entire profile */
                background-color: #fff; /* White background */
                border-radius: 10px;
                max-width: 1200px;
                margin: 0 auto; /* Center the container */
            }
    
            .profile-header {
        display: flex;
        align-items: center;
        justify-content: space-between; /* Razmak između naslova i slike */
        margin-bottom: 20px;
    }
            /* Title styling within the large outline box */
            .profile-title {
        font-size: 24px; /* Vraćen originalni font za bolju vidljivost */
        padding: 10px;
        color: #fff;
        background-color: #4b0078;
        border-radius: 8px;
        text-align: center;
        margin: 0 auto 20px auto; /* Centriranje naslova */
        max-width: 400px; /* Smanjena maksimalna širina */
        transform: translateX(58px); /* Podesite vrijednost px po px */
    }
    
    @media screen and (max-width: 768px) {
        .profile-title {
            max-width: 280px; /* Smanjena maksimalna širina za tablete i manje ekrane */
        }
    }
    
    #eth-account-section {
        max-width: 400px; /* Ograničenje širine na desktopu */
        margin: 0 auto; /* Centriranje na desktopu */
    }
    
    @media screen and (max-width: 768px) {
        #eth-account-section {
            max-width: 280px; /* Ograničenje širine za mobilne uređaje */
            margin: 0 auto; /* Centriranje na mobilnim uređajima */
        }
    
        #eth-address-input {
            width: 100%; /* Prilagođavanje širine polja za unos */
        }
    }
    
            /* Container for individual products */
            .product {
                border: 5px solid;
                border-image: linear-gradient(to right, #5a99cd, #4b0078) 1;
                border-radius: 8px;
                padding: 10px;
                margin: 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            }
    
            .product img {
        width: 250px; /* Povećana širina slike */
        height: 250px; /* Povećana visina slike */
        object-fit: cover;
        margin-bottom: 10px;
        border-radius: 8px;
    }
    
    
            .product-name {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 5px;
                text-align: center;
            }
    
            .product-price {
                font-size: 14px;
                color: #333;
                margin-bottom: 10px;
            }
    
            .buy-button, .set-price-button {
                padding: 8px;
                margin-top: 10px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            }
    
            .buy-button {
                background-color: #4CAF50;
                color: white;
            }
    
            .set-price-button {
                background-color: #4b0078;
                color: white;
            }
    
            .input-price {
                width: 100px;
                padding: 5px;
                margin-top: 10px;
                text-align: center;
            }
    
            .product-list-container {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
            }
            #current-price-display {
        font-weight: bold; /* Podebljava sav tekst unutar div-a */
        padding-left: 40px;
    }
    /* Main transaction history container */
    #transaction-history {
        max-width: 800px;
        padding: 15px;
        background-color: #333;
        border-radius: 10px;
        margin: 20px auto;
        color: white;
    }
    
    /* Each transaction item in a fixed-height, single-column list */
    .transaction-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background-color: #444;
        border-radius: 5px;
        height: 80px;
        width: 100%;
        position: relative; /* Enables absolute positioning within */
    }
    
    /* Image styling for a consistent size */
    .transaction-item img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 15px;
    }
    
    /* Transaction details container with more spacing between items */
    .transaction-details {
        display: flex;
        align-items: center;
        color: white;
        width: 100%;
    }
    
    /* Left-aligned name with fixed width */
    .transaction-name {
        font-size: 14px;
        font-weight: bold;
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Centered price */
    .transaction-price {
        font-size: 14px;
        position: absolute;
        left: 50%; /* Center in the middle */
        transform: translateX(-50%); /* Adjusts to center perfectly */
        white-space: nowrap;
    }
    
    /* Right-aligned date */
    .transaction-time {
        font-size: 14px;
        text-align: right;
        white-space: nowrap;
        margin-left: auto; /* Pushes it to the right */
    }
    /* Hide date on screens smaller than 768px */
    @media (max-width: 768px) {
        .transaction-time {
            display: none;
        }
    }
    @media (max-width: 768px) {
        .transaction-price {
            left: 80%; /* Moves the price further to the right on mobile */
            transform: translateX(-50%);
        }
    }
    .profile-picture {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .profile-picture img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    @media (max-width: 768px) {
        .profile-title {
            font-size: 18px; /* Smanjena veličina fonta za mobilne uređaje */
            text-align: left; /* Poravnanje naslova ulijevo */
            max-width: 45%; /* Uklanja ograničenje širine za mobilne uređaje */
            transform: translateX(0); /* Vraća naslov u normalan položaj */
        }
    }
    
    
        </style>



<style>
    body {
        font-family: 'Roboto', sans-serif; /* Promjena fonta */
        margin: 0;
        padding: 0;
        background-color: black;
        
       
    }
   

    @media (max-width: 768px) {
    html, body {
        width: 100%;
        overflow-x: hidden; /* Onemogućava horizontalno pomjeranje */
        margin: 0; /* Uklanja podrazumijevane margine */
        padding: 0; /* Uklanja podrazumijevane paddinge */
    }

    /* Osiguraj da svi kontejneri i elementi imaju odgovarajuću širinu */
    * {
        max-width: 100%; /* Ograničava širinu na 100% */
        box-sizing: border-box; /* Uključuje padding i border u ukupnu širinu */
    }

    img {
        max-width: 100%; /* Održava slike unutar širine kontejnera */
        height: auto; /* Održava odnos slike */
    }

    /* Podesi širinu specifičnih elemenata ako je potrebno */
    .some-element { /* Zameniti sa stvarnim klasama */
        width: 100%; /* Ili odgovarajući procenat */
    }
}

    .background {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .blue {
    background: linear-gradient(to bottom right, rgba(23, 135, 226, 0.6), rgba(0, 0, 0, 0) 50%);
    position: absolute;
    top: 0;
    left: 0;
    width: 50%;
    height: 50%;
    
}


.purple {
    background: linear-gradient(to top left, rgba(128, 0, 128, 0.6), rgba(0, 0, 0, 0) 50%);
    position: fixed; /* Changed to fixed to always stick to the bottom-right */
    bottom: 0;
    right: 0;
    width: 50%;
    height: 50%;
    z-index: 1; /* Make sure it stays below other content if necessary */
}



        
    nav {
        display: flex;
        gap: 20px;
    }
    nav a {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
    }
    nav .material-icons {
        margin-right: 5px; /* Razmak između ikone i teksta */
    }
    .container {
        display: flex;
        
        padding: 20px;
    }
    .icon-section {
    flex: 2;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 20px;
}

.icon {
    background-color: transparent; /* Prozirna pozadina */
    border-radius: 0; /* Pravougaoni oblik */
    display: flex;
    justify-content: center;
    align-items: center;
    width: 120px; /* Širina pravougaonika */
    height: 60px; /* Visina pravougaonika */
    font-size: 24px;
    cursor: pointer;
    position: relative;
    background: transparent; /* Prozirna pozadina */
    color: white; /* Bijela boja teksta */
    border: 2px solid transparent; /* Prozirni obrub (outline) */
    border-image: linear-gradient(to right, #5a99cd, #4b0078) 1; /* Gradijentni obrub s lijeva na desno */


    

    
}

   
    .amount {
        font-size: 24px;
        margin-left: 2px;
    }


/* Stil za ikonice */
.material-icons {
    vertical-align: middle; /* Poravnanje ikone sa tekstom */
    margin-right: 8px; /* Razmak između ikone i teksta */
}


#share-icon {
    background-color: transparent; /* Prozirna pozadina */
    border-radius: 0; /* Pravougaoni oblik */
    display: flex;
    justify-content: center;
    align-items: center;
    width: 150px; /* Širina pravougaonika */
    height: 60px; /* Visina pravougaonika */
    font-size: 22px;
    cursor: pointer;
    position: relative;
    background: transparent; /* Prozirna pozadina */
    color: white; /* Bijela boja teksta */
    border: 2px solid transparent; /* Prozirni obrub (outline) */
    border-image: linear-gradient(to right, #5a99cd, #4b0078) 1; /* Gradijentni obrub s lijeva na desno */


}

#share-icon span.material-icons {
    font-size: 24px; /* Veličina ikone */
}


</style>




<style>
    .partnership-box {
        border-width: 2px; /* debljina obruba */
        border-style: solid; /* stil obruba */
        border-image: linear-gradient(to right, #5a99cd, #4b0078) 1; /* gradijentni obrub s lijeva na desno */
        padding: 20px; /* razmak unutar boxa */
        margin: 20px auto; /* razmak iznad i ispod boxa, centrirano */
        max-width: 600px; /* maksimalna širina boxa */
        text-align: justify; /* opravdanje teksta */
        background-color: #000; /* crna pozadina */
        color: #fff; /* bijela boja teksta */
        border-radius: 50px !important; /* povećanje zaobljenosti ivica */
    }

    .partnership-box p {
        margin: 0; /* uklanja zadani razmak oko paragrafa */
        text-indent: 0; /* nema uvlačenja prve linije */
        line-height: 1.6; /* povećava razmak između redova */
    }

    .partnership-box img {
    width: 100%; /* Postavi osnovnu širinu na 100% da se prilagođava */
    max-width: 600px; /* Maksimalna širina za desktop */
    height: auto; /* Automatsko prilagođavanje visine */
}

/* Za mobilne uređaje */
@media only screen and (max-width: 768px) {
    .partnership-box img {
        max-width: 350px; /* Maksimalna širina za mobitele */
    }
}

</style>




<style>
   header {

  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  position: relative; /* Omogućuje apsolutno pozicioniranje menija */
}


/* Toggle dugme */
.toggle-button {
  display: none; /* Skriveno po defaultu */
  font-size: 30px;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  margin-left: auto;
}

#toggle-menu {
  display: none; /* Skriveno po defaultu */
  flex-direction: column; /* Vertikalno poravnanje menija */
  background: linear-gradient(to bottom, #000000, #4b0078); /* Gradijent od plave do tamno ljubičaste */
  position: absolute;
  right: 0px;
  top: 60px;
  width: 50%;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
  z-index: 100;
}





#toggle-menu a {
  color: white;
  text-decoration: none;
  padding: 10px 20px;
  display: block;
  text-align: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* Stil za desktop meni */
#desktop-menu {
  display: flex;
}

#desktop-menu a {
  margin-left: 20px;
  text-decoration: none;
  color: white;
}

/* Media query za mobilne uređaje */
@media (max-width: 768px) {
  /* Prikaži toggle dugme na mobilnim uređajima */
  .toggle-button {
      display: block;
      transform: translateX(20px); /* Pomjera udesno za 20px */
  }
  /* Sakrij desktop meni na mobilnim uređajima */
  #desktop-menu {
      display: none;
  }

}

.image-container {
    display: flex;
    justify-content: center; /* Centriraj sliku */
    align-items: flex-start; /* Poravnaj gornji dio */
    position: relative;
}

@media (max-width: 768px) {
    .image-container {
        align-items: flex-start; /* Gornji dio */
        transform: translateY(10px); /* Pomakni prema dolje na mobilnim uređajima */
    }
}

.image-container img {
    animation: pulse 3s infinite; /* Animacija nazvana 'pulse' koja traje 2 sekunde i ponavlja se beskonačno */
}

@keyframes pulse {
    0% {
        transform: scale(1); /* Početna veličina */
    }
    50% {
        transform: scale(1.05); /* Blago povećanje veličine */
    }
    100% {
        transform: scale(1); /* Vraćanje na početnu veličinu */
    }
}


  </style>



<style>
    #current-price {
        transform: translateX(130px); /* Podesi ovu vrijednost prema željenom pomjeranju */
}

@media only screen and (max-width: 768px) {
    #current-price {
        transform: translateX(40px); /* Podesi ovu vrijednost prema željenom pomjeranju */
    }
}

#user-name {
    position: relative;
}

@media only screen and (max-width: 768px) {
    #user-name {
        transform: translateX(-20px); /* Pomjeranje ulijevo, prilagodi prema potrebi */
    }
}


</style>
</body>
</html>
