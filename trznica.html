<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tržnica</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>

    <script type="module">
           import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

        // Povezivanje s Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBKfTE0qZdxVLq0lvmli367_yyqpGK-fPA",
            authDomain: "piii-7844e.firebaseapp.com",
            projectId: "piii-7844e",
            storageBucket: "piii-7844e.appspot.com",
            messagingSenderId: "315770496799",
            appId: "1:315770496799:web:0197d4baf2c8731d88722a",
            measurementId: "G-JH9SDWTS9V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Povezivanje s NFT ugovorom
        // Adresa Marketplace ugovora
const marketplaceContractAddress = "0xf0Ce104C3B558FAf2FdFf7dE2649a051b7b4A2bA";
const marketplaceABI = [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "buyToken",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "listToken",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_nftContract",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_lunaToken",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "listings",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lunaToken",
		"outputs": [
			{
				"internalType": "contract IERC20",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "nftContract",
		"outputs": [
			{
				"internalType": "contract IERC721",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

const marketplaceContract = new web3.eth.Contract(marketplaceABI, marketplaceContractAddress);


        const web3 = new Web3(window.ethereum);
        const nftContract = new web3.eth.Contract(nftContractABI, nftContractAddress);

        document.getElementById('publish-product').addEventListener('click', async () => {
    const name = document.getElementById('product-name').value;
    const price = parseFloat(document.getElementById('product-price').value);
    const cryptoPrice = parseFloat(document.getElementById('product-crypto-price').value);
    const file = document.getElementById('product-image').files[0];

    if (!name || !price || !cryptoPrice || !file) {
        alert('Molimo popunite sva polja.');
        return;
    }

    try {
        // Upload slike na Firebase Storage
        const storageRef = ref(storage, 'productImages/' + file.name);
        const snapshot = await uploadBytes(storageRef, file);
        const imageUrl = await getDownloadURL(snapshot.ref);

        // Kreiraj metadata JSON objekt
        const metadata = {
            name: name,
            description: 'Proizvod na Tržnici',
            image: imageUrl,
        };

        // Pretvori metadata objekt u JSON string
        const metadataString = JSON.stringify(metadata);

        // Upload metadata JSON na Firebase Storage
        const metadataBlob = new Blob([metadataString], { type: 'application/json' });
        const metadataRef = ref(storage, 'metadata/' + name + '.json');
        const metadataSnapshot = await uploadBytes(metadataRef, metadataBlob);
        const metadataUrl = await getDownloadURL(metadataSnapshot.ref);

        // Postavi tokenURI na URL metadata JSON datoteke
        const tokenURI = metadataUrl;

        // Mintanje NFT-a
        const accounts = await web3.eth.requestAccounts();
        const currentAccount = accounts[0];
        await nftContract.methods.mintNFT(currentAccount, tokenURI).send({ from: currentAccount });

        // Dohvati tokenId iz pametnog ugovora
        const tokenId = await nftContract.methods.currentTokenId().call();

        // Spremanje proizvoda u Firestore s tokenId-om
        const docRef = await addDoc(collection(db, 'products'), {
            name,
            price,
            cryptoPrice,
            imageUrl,
            tokenId, // Dodaj tokenId u inicijalni zapis
        });

        alert('Proizvod uspješno objavljen i NFT mintovan!');
    } catch (error) {
        console.error('Greška prilikom objave proizvoda ili mintanja NFT-a:', error);
        alert('Došlo je do greške. Pokušajte ponovo.');
    }
});


    </script>
</head>
<body>
    <h1>Dodaj novi proizvod</h1>
    <input type="file" id="product-image" accept="image/*"><br>
    <input type="text" id="product-name" placeholder="Naziv proizvoda"><br>
    <input type="number" id="product-price" placeholder="Cijena proizvoda (u fiat valuti)"><br>
    <input type="number" step="0.01" id="product-crypto-price" placeholder="Cijena proizvoda (u ETH)"><br>
    <button id="publish-product">Objavi</button>
</body>
</html>
