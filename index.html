 buyButton.addEventListener('click', async () => {
    if (productData.sold) {
        alert('Ovaj proizvod je već prodan.');
        return;
    }

    if (typeof window.ethereum === 'undefined') {
        alert('MetaMask nije instaliran! Molimo vas da ga instalirate.');
        return;
    }

    try {
        // Povezivanje sa MetaMask-om
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const web3 = new Web3(window.ethereum);

        // Trenutni korisnički račun
        const accounts = await web3.eth.getAccounts();
        const currentAccount = accounts[0];

        // Povezivanje s LUNA token ugovorom
        const lunaTokenContract = new web3.eth.Contract(contractABI, contractAddress);

        // Provjera balansa korisnika
        const userBalance = await lunaTokenContract.methods.balanceOf(currentAccount).call();
        const requiredAmount = web3.utils.toWei(productData.price.toString(), 'ether'); // Pretvaranje cijene u Wei

        if (parseFloat(userBalance) < parseFloat(requiredAmount)) {
            alert('Nemate dovoljno LUNA tokena za ovu transakciju.');
            return;
        }

        // Prijenos tokena prodavcu
        const sellerAddress = '0x6CB206Ac2FA76dee5eD03253942FE2fda92b48E9'; // Adresa prodavca
        await lunaTokenContract.methods
            .transfer(sellerAddress, requiredAmount)
            .send({ from: currentAccount });

        // Prijenos vlasništva nad NFT-om
        const tokenId = productData.tokenId; // Dodajte tokenId u Firestore prilikom mintanja
        const nftContract = new web3.eth.Contract(nftContractABI, nftContractAddress);
        const currentOwner = await nftContract.methods.ownerOf(tokenId).call();

        if (currentOwner.toLowerCase() !== sellerAddress.toLowerCase()) {
            alert('Greška: NFT ne pripada prodavcu!');
            return;
        }

        // Transfer NFT-a
        await nftContract.methods
            .safeTransferFrom(sellerAddress, currentAccount, tokenId)
            .send({ from: sellerAddress });

        // Ažuriranje Firestore baze podataka za proizvod
        const productDocRef = doc(db, 'products', productId);
        await updateDoc(productDocRef, {
            sold: true,
            owner: userId,
            ownerName: username,
        });

        // Dodavanje proizvoda u kupovine korisnika
        const userPurchasesRef = collection(db, `network/${userId}/purchases`);
        await addDoc(userPurchasesRef, {
            name: productData.name,
            imageUrl: productData.imageUrl,
            price: productData.price,
            purchaseTime: new Date(),
        });

        // Promjena izgleda nakon uspješne kupovine
        buyButton.textContent = 'Sold';
        buyButton.style.backgroundColor = 'red';
        buyButton.disabled = true;

        // Prikaz vlasnika
        ownerDiv.textContent = `Novi vlasnik: ${username}`;
        ownerDiv.style.color = 'white';
        ownerDiv.style.cursor = 'pointer';
        ownerDiv.addEventListener('click', () => {
            window.location.href = `profile.html?ime=${username}`;
        });
        productDiv.appendChild(ownerDiv);

        alert(`Kupili ste ${productData.name} za ${productData.price} LUNA tokena!`);
    } catch (error) {
        console.error('Greška prilikom obrade transakcije:', error);
        alert('Došlo je do greške. Pokušajte ponovo.');
    }
});
